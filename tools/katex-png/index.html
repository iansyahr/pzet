<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <meta name="theme-color" content="#0ea5e9" />
  <link rel="icon" type="image/avif" href="https://pzet.pages.dev/tools/katex-png/icon-katex.avif" />
  <title>KaTeX PNG Converter â€” Elegant</title>

  <!-- KaTeX -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" crossorigin="anonymous" />
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" crossorigin="anonymous"></script>

  <!-- html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- Styles -->
  <style>
    :root{
      --bg: #0b1020;           /* page bg (dark) */
      --card: #0f172a;         /* surfaces */
      --text: #e2e8f0;         /* primary text */
      --muted: #94a3b8;        /* secondary text */
      --ring: #38bdf8;         /* focus ring */
      --brand: #0ea5e9;        /* buttons */
      --brand-600: #0284c7;
      --ok: #22c55e;
      --warn: #f59e0b;
      --danger: #ef4444;
      --border: #1f2a44;
      --checker-a: #0b1020;    /* checkerboard */
      --checker-b: #0e162c;
    }

    @media (prefers-color-scheme: light){
      :root{
        --bg:#f7f8fb; --card:#ffffff; --text:#0f172a; --muted:#475569; --ring:#2563eb; --brand:#2563eb; --brand-600:#1d4ed8; --border:#e5e7eb; --checker-a:#f0f2f7; --checker-b:#e6e9f2;
      }
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font: 14px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 80% -10%, rgba(56,189,248,.18), transparent 40%),
                  radial-gradient(900px 700px at 0% 100%, rgba(34,197,94,.12), transparent 35%),
                  var(--bg);
      color: var(--text);
    }

    .wrap{max-width:1100px;margin:32px auto;padding:20px}
    .appbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px
    }
    .title{display:flex;gap:10px;align-items:center}
    .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--brand),#22c55e);box-shadow:0 6px 20px rgba(14,165,233,.35)}
    .title h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.2px}
    .app-actions{display:flex;gap:8px;align-items:center}

    .btn{appearance:none;border:1px solid var(--border);background:var(--card);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer;transition:.15s;display:inline-flex;gap:8px;align-items:center}
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.primary{background:var(--brand);border-color:transparent;color:#fff}
    .btn.primary:hover{background:var(--brand-600)}
    .btn.ok{background:var(--ok);border-color:transparent;color:#fff}
    .btn.ghost{background:transparent}
    .btn[disabled]{opacity:.6;cursor:not-allowed;transform:none}

    .grid{display:grid;grid-template-columns: 1fr 1fr;gap:16px}
    @media (max-width: 920px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
    .card h2{margin:0 0 12px;font-size:14px;letter-spacing:.3px;text-transform:uppercase;color:var(--muted)}

    .stack{display:flex;flex-direction:column;gap:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-weight:600}

    textarea, select, input[type="text"], input[type="number"], input[type="color"]{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--text);font-size:14px;transition:border-color .15s, box-shadow .15s
    }
    textarea{min-height:160px;font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;resize:vertical}
    textarea:focus, select:focus, input:focus{outline:none;border-color:transparent;box-shadow:0 0 0 3px color-mix(in oklab, var(--ring) 40%, transparent)}

    fieldset{border:1px dashed var(--border);border-radius:12px;padding:10px 12px}
    legend{padding:0 6px;color:var(--muted);font-weight:600;font-size:12px}

    .preview-box{
      position:relative;border-radius:14px;border:1px solid var(--border);padding:14px;min-height:220px;display:flex;align-items:center;justify-content:center;overflow:auto;
      background: repeating-conic-gradient(from 45deg, var(--checker-a) 0% 25%, var(--checker-b) 0% 50%) 0 0 / 24px 24px;
    }
    .preview-inner{max-width:100%;background:transparent}
    .placeholder{color:var(--muted);font-style:italic;text-align:center}

    .controls-grid{display:grid;grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px}
    @media (max-width: 520px){.controls-grid{grid-template-columns:1fr}}

    .subtle{color:var(--muted)}
    .kbd{font: 500 12px/1 ui-monospace, SFMono-Regular; background:color-mix(in oklab, var(--muted) 16%, transparent); padding:6px 8px; border-radius:8px; border:1px solid var(--border)}
    .footer{margin-top:18px;color:var(--muted);font-size:12px;text-align:center}

    .ring{box-shadow:0 0 0 3px color-mix(in oklab, var(--ring) 40%, transparent)}
    .hidden{position:absolute;left:-9999px;top:-9999px}

    /* toast */
    .toast{position:fixed;right:16px;bottom:16px;z-index:30;display:none}
    .toast.show{display:block}
    .toast > div{background:var(--card);border:1px solid var(--border);padding:10px 12px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.12)}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="appbar">
      <div class="title">
        <div class="logo" aria-hidden="true"></div>
        <h1>KaTeX PNG Converter</h1>
      </div>
      <div class="app-actions">
        <button id="themeBtn" class="btn ghost" title="Toggle tema (Ctrl+J)">ğŸŒ“ <span class="hide-sm">Tema</span></button>
        <button id="clearBtn" class="btn ghost" title="Bersihkan input (Esc)">ğŸ§¹ Bersihkan</button>
        <button id="genBtnTop" class="btn primary" title="Generate (Ctrl+Enter)">âš¡ Generate</button>
      </div>
    </header>

    <section class="grid">
      <!-- Left: Input -->
      <div class="card stack" aria-labelledby="lbl-input">
        <h2 id="lbl-input">Input LaTeX</h2>
        <textarea id="latex" spellcheck="false" placeholder="Contoh: c = \\pm\\sqrt{a^2 + b^2}">c = \\pm\\sqrt{a^2 + b^2}</textarea>

        <div class="controls-grid">
          <fieldset>
            <legend>Mode</legend>
            <div class="row">
              <label class="row"><input type="radio" name="mode" value="inline"> Inline</label>
              <label class="row"><input type="radio" name="mode" value="display" checked> Display</label>
            </div>
          </fieldset>
          <fieldset>
            <legend>Skala PNG</legend>
            <select id="scale">
              <option value="1">100%</option>
              <option value="1.5">150%</option>
              <option value="2" selected>200% (disarankan)</option>
              <option value="3">300%</option>
              <option value="4">400%</option>
              <option value="5">500%</option>
              <option value="10">1000%</option>
            </select>
          </fieldset>
          <fieldset>
            <legend>Ukuran Preview</legend>
            <select id="previewZoom">
              <option value="1">100%</option>
              <option value="1.25">125%</option>
              <option value="1.5">150%</option>
              <option value="2">200%</option>
            </select>
          </fieldset>
          <fieldset>
            <legend>Padding</legend>
            <div class="row">
              <input type="number" id="pad" min="0" max="80" step="2" value="12" style="max-width:110px" />
              <span class="subtle">px sekeliling formula</span>
            </div>
          </fieldset>
          <fieldset>
            <legend>Background</legend>
            <div class="row" style="align-items:center">
              <label class="row"><input type="checkbox" id="transparent" checked> Transparan</label>
              <input type="color" id="bgColor" value="#ffffff" title="Warna latar saat tidak transparan" />
            </div>
          </fieldset>
          <fieldset>
            <legend>Preset Contoh</legend>
            <div class="row" style="gap:6px">
              <select id="preset">
                <option value="">â€” pilih contoh â€”</option>
                <option value="E=mc^2">E=mc^2</option>
                <option value="F=ma">F=ma</option>
                <option value="i\,\hbar\,\frac{\partial}{\partial t}\,\Psi = -\frac{\hbar^2}{2m}\nabla^2\Psi + V\,\Psi">Pers. SchrÃ¶dinger</option>
                <option value="\oint_{\partial S} \vec E\cdot d\vec l = -\frac{d}{dt}\int_S \vec B\cdot d\vec A">Hukum Faraday</option>
                <option value="f(x)=\int_{-\infty}^{\infty}\hat f(\xi)\,e^{2\pi i\xi x}\,d\xi">Transform Fourier</option>
              </select>
              <button id="insertPreset" class="btn" title="Ganti input dengan preset">â†©ï¸ Sisipkan</button>
            </div>
          </fieldset>
        </div>

        <div class="row" style="justify-content:flex-end">
          <button id="genBtn" class="btn primary">âš¡ Generate PNG</button>
        </div>

        <div id="err" class="subtle" role="alert" style="min-height:20px;color:var(--danger);"></div>
        <p class="subtle">Tips: <span class="kbd">Ctrl</span> + <span class="kbd">Enter</span> untuk generate â€¢ <span class="kbd">Esc</span> untuk bersihkan â€¢ <span class="kbd">Ctrl</span> + <span class="kbd">J</span> toggle tema</p>
      </div>

      <!-- Right: Preview & Output -->
      <div class="card stack" aria-labelledby="lbl-preview">
        <h2 id="lbl-preview">Preview</h2>
        <div id="previewBox" class="preview-box">
          <div id="latexPreview" class="preview-inner"><div class="placeholder">Preview akan muncul di siniâ€¦</div></div>
        </div>

        <h2>Hasil PNG</h2>
        <div id="pngBox" class="preview-box" aria-live="polite">
          <img id="png" alt="Hasil render LaTeX" style="display:none;max-width:100%" />
          <div id="pngHint" class="placeholder">Klik <b>Generate</b> untuk membuat gambar</div>
        </div>

        <div class="row" style="justify-content:center;gap:10px;flex-wrap:wrap">
          <button id="copyBtn" class="btn" disabled>ğŸ“‹ Salin PNG</button>
          <a id="dl" class="btn ok" download="latex.png" href="#" aria-disabled="true">ğŸ’¾ Unduh PNG</a>
        </div>
      </div>
    </section>

    <div class="footer">Made with KaTeX Â· html2canvas Â· No frameworks Â· Â© 2025</div>
  </div>

  <!-- Hidden render container -->
  <div id="renderHost" class="hidden"></div>

  <div id="toast" class="toast"><div id="toastMsg">Tersalin!</div></div>

  <script>
    // Elements
    const latex = document.getElementById('latex');
    const preview = document.getElementById('latexPreview');
    const previewBox = document.getElementById('previewBox');
    const genBtn = document.getElementById('genBtn');
    const genBtnTop = document.getElementById('genBtnTop');
    const copyBtn = document.getElementById('copyBtn');
    const dl = document.getElementById('dl');
    const png = document.getElementById('png');
    const pngBox = document.getElementById('pngBox');
    const pngHint = document.getElementById('pngHint');
    const err = document.getElementById('err');

    const scaleSel = document.getElementById('scale');
    const modeRadios = document.querySelectorAll('input[name="mode"]');
    const padInput = document.getElementById('pad');
    const transparentChk = document.getElementById('transparent');
    const bgColorInput = document.getElementById('bgColor');
    const previewZoom = document.getElementById('previewZoom');
    const presetSel = document.getElementById('preset');
    const insertPreset = document.getElementById('insertPreset');

    const renderHost = document.getElementById('renderHost');
    const themeBtn = document.getElementById('themeBtn');
    const clearBtn = document.getElementById('clearBtn');

    const toast = document.getElementById('toast');
    const toastMsg = document.getElementById('toastMsg');

    let debounce;

    // Helpers
    const showToast = (msg='Tersalin!')=>{toastMsg.textContent=msg;toast.classList.add('show');setTimeout(()=>toast.classList.remove('show'),1400)};

    const setLoading = (flag)=>{
      [genBtn, genBtnTop].forEach(b=>{b.disabled=flag; b.textContent = flag ? 'â³ Memprosesâ€¦' : (b===genBtnTop?'âš¡ Generate':'âš¡ Generate PNG')});
    };

    const disableOutput = ()=>{
      png.style.display='none'; png.src=''; pngHint.style.display='block'; copyBtn.disabled=true; dl.setAttribute('aria-disabled','true');
    };

    const enableOutput = (url)=>{
      png.src=url; png.style.display='block'; pngHint.style.display='none'; copyBtn.disabled=false; dl.href=url; dl.setAttribute('aria-disabled','false');
    };

    const currentMode = ()=>[...modeRadios].find(r=>r.checked)?.value || 'display';

    const latexToName = (s)=>{
      const clean = s.replace(/\\[a-zA-Z]+|[^a-zA-Z0-9]+/g,' ').trim().split(/\s+/).slice(0,6).join('-').toLowerCase();
      return clean || 'latex';
    };

    const updatePreview = ()=>{
      const code = latex.value.trim();
      if(!code){ preview.innerHTML = '<div class="placeholder">Masukkan LaTeX untuk melihat previewâ€¦</div>'; previewBox.classList.remove('ring'); return; }
      try{
        katex.render(code, preview, {displayMode: currentMode()==='display', throwOnError:true, output:'html'});
        preview.style.padding = Math.max(0, parseInt(padInput.value)||0) + 'px';
        preview.style.transform = `scale(${parseFloat(previewZoom.value)||1})`;
        preview.style.transformOrigin = 'top left';
        previewBox.classList.add('ring');
        err.textContent='';
      }catch(e){
        preview.innerHTML = `<span style="color:var(--danger);font-style:italic">Error: ${e.message.replace(/KaTeX parse error: /g,'')}</span>`;
        previewBox.classList.remove('ring');
      }
      disableOutput();
    };

    const renderForExport = ()=>{
      const code = latex.value.trim();
      if(!code){ err.textContent='Input LaTeX tidak boleh kosong.'; return; }
      err.textContent='';

      // prepare host
      renderHost.innerHTML = '';
      const wrapper = document.createElement('div');
      wrapper.style.display='inline-block';
      wrapper.style.padding = Math.max(0, parseInt(padInput.value)||0) + 'px';

      if(transparentChk.checked){
        wrapper.style.backgroundColor = 'transparent';
      } else {
        wrapper.style.backgroundColor = bgColorInput.value || '#ffffff';
      }

      renderHost.appendChild(wrapper);

      // render katex inside wrapper
      try{
        katex.render(code, wrapper, {displayMode: currentMode()==='display', throwOnError:true, output:'html'});
      }catch(e){
        err.textContent = 'Error KaTeX: ' + e.message.replace(/KaTeX parse error: /g,'');
        return;
      }

      // html2canvas options
      const scale = Math.max(1, parseFloat(scaleSel.value)||2);
      const bg = transparentChk.checked ? null : (bgColorInput.value||'#ffffff');

      setLoading(true);
      html2canvas(wrapper, {backgroundColor: bg, scale, useCORS:true, allowTaint:false})
        .then(canvas=>{
          const url = canvas.toDataURL('image/png');
          enableOutput(url);
          const name = latexToName(code);
          dl.download = `${name}.png`;
        })
        .catch(err2=>{ console.error(err2); err.textContent = 'Error html2canvas: '+err2.message; disableOutput(); })
        .finally(()=> setLoading(false));
    };

    const dataURLtoBlob = (dataurl)=>{
      const [meta, data] = dataurl.split(',');
      const mime = meta.match(/:(.*?);/)[1];
      const bin = atob(data); const len = bin.length; const u8 = new Uint8Array(len);
      for(let i=0;i<len;i++) u8[i] = bin.charCodeAt(i);
      return new Blob([u8], {type:mime});
    };

    const copyPNG = async ()=>{
      if(!png.src){ showToast('Buat PNG dulu'); return; }
      if(!navigator.clipboard || !navigator.clipboard.write){ showToast('Clipboard gambar tak didukung'); return; }
      try{
        await navigator.clipboard.write([new ClipboardItem({'image/png': dataURLtoBlob(png.src)})]);
        showToast('PNG tersalin ke clipboard');
      }catch(e){ console.error(e); showToast('Gagal menyalin PNG'); }
    };

    // Events
    const onInput = ()=>{ clearTimeout(debounce); debounce = setTimeout(updatePreview, 200); };
    latex.addEventListener('input', onInput);
    [padInput, previewZoom].forEach(el=> el.addEventListener('input', updatePreview));
    modeRadios.forEach(r=> r.addEventListener('change', updatePreview));

    scaleSel.addEventListener('change', ()=> disableOutput());
    transparentChk.addEventListener('change', ()=>{ bgColorInput.disabled = transparentChk.checked; updatePreview(); });
    bgColorInput.addEventListener('input', updatePreview);

    genBtn.addEventListener('click', renderForExport);
    genBtnTop.addEventListener('click', renderForExport);
    copyBtn.addEventListener('click', copyPNG);

    insertPreset.addEventListener('click', ()=>{
      if(!presetSel.value) return; latex.value = presetSel.value; updatePreview(); latex.focus();
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' && (e.ctrlKey||e.metaKey)){ e.preventDefault(); renderForExport(); }
      if(e.key==='Escape'){ latex.value=''; updatePreview(); }
      if((e.ctrlKey||e.metaKey) && (e.key.toLowerCase()==='j')){ e.preventDefault(); toggleTheme(); }
    });

    // Theme toggle (persist)
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
    const getTheme = ()=> localStorage.getItem('kpx-theme') || (prefersDark.matches? 'dark':'light');
    const applyTheme = (t)=>{ document.documentElement.style.colorScheme = t; document.documentElement.dataset.theme = t; };
    const toggleTheme = ()=>{ const t = getTheme()==='dark'?'light':'dark'; localStorage.setItem('kpx-theme', t); applyTheme(t); };
    themeBtn.addEventListener('click', toggleTheme);
    applyTheme(getTheme());

    clearBtn.addEventListener('click', ()=>{ latex.value=''; updatePreview(); latex.focus(); });

    // Init
    window.addEventListener('load', ()=>{ updatePreview(); });
  </script>
</body>
</html>
