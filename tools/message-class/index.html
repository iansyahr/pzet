<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Potong Tabel - Versi Cepat</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f9; color: #333; max-width: 900px; margin: 20px auto; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); border-radius: 8px; }
        h1, h2 { text-align: center; color: #444; }
        #controls { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; padding: 20px; background-color: #fff; border: 1px dashed #ccc; border-radius: 8px; }
        input[type="file"] { padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 12px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        button:hover { background-color: #0069d9; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }

        #log-container {
            background-color: #2b3035;
            color: #c0c5ce;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
            height: 300px;
            overflow-y: scroll;
            border: 1px solid #444;
        }
        #log-container p {
            margin: 0 0 5px 0;
            padding: 2px 5px;
            white-space: pre-wrap;
        }
        .log-step { font-weight: bold; color: #66d9ef; border-top: 1px solid #555; padding-top: 8px; margin-top: 8px;}
        .log-info { color: #e6e6e6; }
        .log-success { color: #a6e22e; font-weight: bold; }
        .log-error { color: #f92672; font-weight: bold; }
        .log-warning { color: #fd971f; }

        .processing-steps { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 20px; }
        .processing-steps canvas { max-width: 45%; border: 1px solid #ccc; }
        #result-container { text-align: center; }
        #result-container img { max-width: 100%; margin-top: 10px; border: 2px solid #17a2b8; border-radius: 4px; }
    </style>
</head>
<body>

    <h1>Potong Tabel - Versi Cepat & Efisien</h1>
    <p>Unggah gambar Anda, lalu perhatikan log proses di bawah untuk melihat setiap langkah yang dilakukan skrip secara detail.</p>

    <div id="controls">
        <label for="imageUpload">Pilih gambar tabel:</label>
        <input type="file" id="imageUpload" accept="image/*">
        <button id="processButton">Mulai Proses Cepat</button>
    </div>

    <h2>Log Proses</h2>
    <div id="log-container">
        <p class="log-info">Memuat library, harap tunggu...</p>
    </div>
    
    <div class="processing-steps">
        <canvas id="canvasPreview" style="display:none;"></canvas>
    </div>

    <div id="result-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script async src="https://docs.opencv.org/4.9.0/opencv.js" onload="onOpenCvReady();"></script>

    <script>
        const imageUpload = document.getElementById('imageUpload');
        const processButton = document.getElementById('processButton');
        const logContainer = document.getElementById('log-container');
        const resultContainer = document.getElementById('result-container');
        const canvasPreview = document.getElementById('canvasPreview');
        
        processButton.disabled = true;

        function logToUI(message, type = 'info') {
            const p = document.createElement('p');
            p.textContent = message;
            p.className = `log-${type}`;
            logContainer.appendChild(p);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function onOpenCvReady() {
            cv.onRuntimeInitialized = () => {
                console.log('OpenCV runtime is now ready.');
                processButton.disabled = false;
                logToUI('Sistem siap. Silakan pilih gambar dan mulai proses.', 'success');
            };
        }

        imageUpload.addEventListener('change', () => {
            if (imageUpload.files.length > 0 && !processButton.disabled) {
                 processButton.textContent = 'Mulai Proses Cepat';
            }
        });

        processButton.addEventListener('click', () => {
            const file = imageUpload.files[0];
            if (!file) { logToUI('Silakan pilih file gambar terlebih dahulu!', 'error'); return; }
            
            logContainer.innerHTML = '';
            resultContainer.innerHTML = '';
            canvasPreview.style.display = 'none';

            processButton.disabled = true;
            processButton.textContent = 'Memproses...';
            logToUI('Proses dimulai...', 'info');

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => startOptimizedProcessing(img);
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });

        async function startOptimizedProcessing(img) {
            let worker = null;
            let src = null;
            let leftColumnMat = null;
            try {
                // Langkah 1: Muat gambar ke OpenCV
                logToUI('Langkah 1: Memuat dan Mempersiapkan Gambar', 'step');
                src = cv.imread(img);
                logToUI('  > Gambar asli berhasil dimuat.', 'info');

                // Langkah 2: Potong bagian kiri gambar untuk di-OCR
                logToUI('Langkah 2: Mengisolasi Kolom Kiri untuk OCR', 'step');
                const roiWidth = src.cols * 0.45; // Ambil 45% lebar gambar dari kiri
                let roiRect = new cv.Rect(0, 0, roiWidth, src.rows);
                leftColumnMat = src.roi(roiRect);
                logToUI(`  > Memotong area [lebar: ${Math.round(roiWidth)}, tinggi: ${src.rows}] untuk dianalisis.`, 'info');
                
                // Tampilkan pratinjau area yang di-OCR
                canvasPreview.style.display = 'block';
                cv.imshow(canvasPreview, leftColumnMat);

                // Langkah 3: Jalankan OCR hanya sekali pada area yang dipotong
                logToUI('Langkah 3: Menjalankan OCR (Satu Kali)', 'step');
                logToUI('  > Membuat & menginisialisasi Tesseract worker...', 'info');
                worker = await Tesseract.createWorker('eng');
                logToUI('  > Worker berhasil dibuat. Memulai pengenalan teks...', 'success');
                
                const { data } = await worker.recognize(leftColumnMat.data, leftColumnMat.cols, leftColumnMat.rows, 'png');
                logToUI(`  > OCR selesai. Ditemukan ${data.words.length} kata.`, 'success');

                // Langkah 4: Cari kata kunci dari hasil OCR
                logToUI('Langkah 4: Mencari Kata Kunci "ITA" & "3550"', 'step');
                const itaWord = data.words.find(w => w.text.toUpperCase().includes('ITA'));
                const numWord = data.words.find(w => w.text.includes('3550'));

                if (!itaWord) {
                    throw new Error('Kata kunci "ITA" tidak ditemukan di kolom kiri gambar.');
                }
                if (!numWord) {
                    throw new Error('Kata kunci "3550" tidak ditemukan di kolom kiri gambar.');
                }

                logToUI(`  > Kata "ITA" ditemukan di [x:${itaWord.bbox.x0}, y:${itaWord.bbox.y0}]`, 'success');
                logToUI(`  > Kata "3550" ditemukan di [x:${numWord.bbox.x0}, y:${numWord.bbox.y0}]`, 'success');
                
                // Cek apakah kedua kata berada di baris yang sama secara vertikal
                const verticalOverlap = Math.max(0, Math.min(itaWord.bbox.y1, numWord.bbox.y1) - Math.max(itaWord.bbox.y0, numWord.bbox.y0));
                if (verticalOverlap === 0) {
                     logToUI(`  > Peringatan: "ITA" dan "3550" tidak berada pada baris yang sama persis secara vertikal. Tetap melanjutkan dengan asumsi baris terdekat.`, 'warning');
                }

                // Langkah 5: Tentukan batas baris dan potong gambar asli
                logToUI('Langkah 5: Menentukan Batas Baris & Memotong Gambar Asli', 'step');
                const padding = 5; // Tambahkan sedikit ruang di atas dan bawah
                const rowTop = Math.min(itaWord.bbox.y0, numWord.bbox.y0) - padding;
                const rowBottom = Math.max(itaWord.bbox.y1, numWord.bbox.y1) + padding;
                const rowHeight = rowBottom - rowTop;

                // Pastikan koordinat valid
                const finalY = Math.max(0, rowTop);
                const finalHeight = Math.min(src.rows - finalY, rowHeight);
                
                const finalRect = new cv.Rect(0, finalY, src.cols, finalHeight);
                let finalCrop = src.roi(finalRect);
                logToUI(`  > Memotong baris target dari gambar asli pada y:${finalY} dengan tinggi ${finalHeight}.`, 'info');

                // Tampilkan hasil
                const resultCanvas = document.createElement('canvas');
                cv.imshow(resultCanvas, finalCrop);
                
                resultContainer.innerHTML = '<h2>Hasil Potongan Final:</h2>';
                const resultImage = new Image();
                resultImage.src = resultCanvas.toDataURL('image/png');
                resultContainer.appendChild(resultImage);

                logToUI('PROSES SELESAI!', 'success');

                // Membersihkan memori OpenCV
                src.delete();
                leftColumnMat.delete();
                finalCrop.delete();

            } catch (error) {
                console.error("Terjadi kesalahan:", error);
                logToUI(`Error: ${error.message}`, 'error');
            } finally {
                if (worker) {
                    logToUI('Mematikan Tesseract worker...', 'info');
                    await worker.terminate();
                    logToUI('Worker berhasil dimatikan.', 'success');
                }
                processButton.disabled = false;
                processButton.textContent = 'Mulai Proses Cepat';
            }
        }
    </script>

</body>
</html>
