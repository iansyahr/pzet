<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Potong Tabel - Template Matching (Robust v2)</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f9; color: #333; max-width: 900px; margin: 20px auto; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); border-radius: 8px; }
        h1, h2 { text-align: center; color: #444; }
        #controls { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; padding: 20px; background-color: #fff; border: 1px dashed #ccc; border-radius: 8px; }
        input[type="file"] { padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 12px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }

        #log-container {
            background-color: #2b3035;
            color: #c0c5ce;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
            height: 300px;
            overflow-y: scroll;
            border: 1px solid #444;
        }
        #log-container p {
            margin: 0 0 5px 0;
            padding: 2px 5px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .log-step { font-weight: bold; color: #66d9ef; border-top: 1px solid #555; padding-top: 8px; margin-top: 8px;}
        .log-info { color: #e6e6e6; }
        .log-success { color: #a6e22e; font-weight: bold; }
        .log-error { color: #f92672; font-weight: bold; }
        .log-warning { color: #fd971f; }

        .processing-steps { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 20px; }
        .processing-steps canvas { max-width: 45%; border: 1px solid #ccc; }
        #result-container { text-align: center; }
        #result-container img { max-width: 100%; margin-top: 10px; border: 2px solid #17a2b8; border-radius: 4px; }
    </style>
</head>
<body>

    <h1>Potong Tabel - Template Matching (Robust)</h1>
    <p>Metode ini mencari semua kemungkinan lokasi template, lalu menemukan pasangan yang berada di baris yang sama untuk menghindari hasil positif palsu.</p>

    <div id="controls">
        <label for="imageUpload">Pilih gambar tabel:</label>
        <input type="file" id="imageUpload" accept="image/*">
        <button id="processButton">Mulai Proses Cepat</button>
    </div>

    <h2>Log Proses</h2>
    <div id="log-container">
        <p class="log-info">Memuat library, harap tunggu...</p>
    </div>
    
    <div class="processing-steps">
        <canvas id="canvasPreview" style="display:none;"></canvas>
    </div>

    <div id="result-container"></div>

    <script async src="https://docs.opencv.org/4.9.0/opencv.js" onload="onOpenCvReady();"></script>

    <script>
        const imageUpload = document.getElementById('imageUpload');
        const processButton = document.getElementById('processButton');
        const logContainer = document.getElementById('log-container');
        const resultContainer = document.getElementById('result-container');
        const canvasPreview = document.getElementById('canvasPreview');
        
        processButton.disabled = true;

        function logToUI(message, type = 'info') {
            const p = document.createElement('p');
            p.textContent = message;
            p.className = `log-${type}`;
            logContainer.appendChild(p);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function onOpenCvReady() {
            cv.onRuntimeInitialized = () => {
                console.log('OpenCV runtime is now ready.');
                processButton.disabled = false;
                logToUI('Sistem siap. Silakan pilih gambar dan mulai proses.', 'success');
            };
        }

        processButton.addEventListener('click', () => {
            const file = imageUpload.files[0];
            if (!file) { logToUI('Silakan pilih file gambar terlebih dahulu!', 'error'); return; }
            
            logContainer.innerHTML = '';
            resultContainer.innerHTML = '';
            canvasPreview.style.display = 'none';

            processButton.disabled = true;
            processButton.textContent = 'Memproses...';
            logToUI('Proses dimulai...', 'info');

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => startAdvancedProcessing(img);
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });

        async function startAdvancedProcessing(img) {
            let src = null, gray = null, binary = null, invertedBinary = null;
            let contours = null, hierarchy = null, finalCrop = null;

            try {
                logToUI('Langkah 1: Pra-pemrosesan Gambar', 'step');
                src = cv.imread(img);
                gray = new cv.Mat();
                cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
                logToUI('  > Gambar diubah ke grayscale.', 'info');
                
                binary = new cv.Mat();
                cv.adaptiveThreshold(gray, binary, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, 11, 2);
                logToUI('  > Threshold adaptif diterapkan.', 'info');
                
                canvasPreview.style.display = 'block';
                cv.imshow(canvasPreview, binary);
                
                logToUI('Langkah 2: Pencarian Semua Kandidat Template', 'step');
                
                const createTemplateMat = (text) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const fontSize = 20;
                    ctx.font = `bold ${fontSize}px Arial`;
                    const textMetrics = ctx.measureText(text);
                    canvas.width = textMetrics.width + 10;
                    canvas.height = fontSize + 10;
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = 'black';
                    ctx.font = `bold ${fontSize}px Arial`;
                    ctx.fillText(text, 5, fontSize);
                    let templateRgba = cv.imread(canvas);
                    let templateGray = new cv.Mat();
                    cv.cvtColor(templateRgba, templateGray, cv.COLOR_RGBA2GRAY);
                    templateRgba.delete();
                    return templateGray;
                };

                const findAllMatches = (source, template, threshold) => {
                    let result = new cv.Mat();
                    let mask = new cv.Mat();
                    cv.matchTemplate(source, template, result, cv.TM_CCOEFF_NORMED, mask);

                    // --- [OPSIONAL] Baris debug untuk melihat skor maksimum ---
                    let maxScore = cv.minMaxLoc(result, mask).maxVal;
                    logToUI(`  > [DEBUG] Skor kecocokan maksimum yang ditemukan: ${maxScore.toFixed(4)}`, 'warning');
                    // --- Akhir baris debug ---

                    const locations = [];
                    for (let y = 0; y < result.rows; y++) {
                        for (let x = 0; x < result.cols; x++) {
                            const score = result.floatAt(y, x);
                            if (score >= threshold) {
                                locations.push({ x, y, score });
                            }
                        }
                    }
                    result.delete();
                    mask.delete();
                    return locations;
                };

                const templateITA = createTemplateMat('ITA');
                const template3550 = createTemplateMat('3550');
                
                // =======================================================
                // === PERUBAHAN UTAMA DI SINI: MENURUNKAN THRESHOLD ===
                // =======================================================
                const threshold = 0.7; // Coba dengan nilai yang lebih rendah
                
                logToUI(`  > Mencari semua kandidat "ITA" dengan skor > ${threshold}...`, 'info');
                const itaCandidates = findAllMatches(binary, templateITA, threshold);
                logToUI(`  > Mencari semua kandidat "3550" dengan skor > ${threshold}...`, 'info');
                const numCandidates = findAllMatches(binary, template3550, threshold);
                
                templateITA.delete();
                template3550.delete();
                
                logToUI(`  > Ditemukan ${itaCandidates.length} kandidat untuk "ITA".`, 'success');
                logToUI(`  > Ditemukan ${numCandidates.length} kandidat untuk "3550".`, 'success');

                if (itaCandidates.length === 0 || numCandidates.length === 0) {
                    throw new Error('Salah satu atau kedua template tidak ditemukan di gambar. Coba turunkan nilai "threshold" di dalam kode.');
                }

                logToUI('Langkah 3: Mencari Pasangan Kandidat di Baris yang Sama', 'step');
                let targetItaLoc = null;
                let targetNumLoc = null;
                const yTolerance = 20;

                for (const itaCand of itaCandidates) {
                    for (const numCand of numCandidates) {
                        if (Math.abs(itaCand.y - numCand.y) < yTolerance) {
                            targetItaLoc = itaCand;
                            targetNumLoc = numCand;
                            break;
                        }
                    }
                    if (targetItaLoc) {
                        break;
                    }
                }

                if (!targetItaLoc || !targetNumLoc) {
                    throw new Error('Gagal menemukan pasangan "ITA" dan "3550" di baris yang sama.');
                }
                logToUI(`  > Pasangan ditemukan! "ITA" di y=${targetItaLoc.y}, "3550" di y=${targetNumLoc.y}`, 'success');

                logToUI('Langkah 4: Isolasi Baris Target & Deteksi Sel Presisi', 'step');
                
                const rowY = Math.min(targetItaLoc.y, targetNumLoc.y);
                const rowHeight = 40;
                
                invertedBinary = new cv.Mat();
                cv.bitwise_not(binary, invertedBinary);
                contours = new cv.MatVector();
                hierarchy = new cv.Mat();
                cv.findContours(invertedBinary, contours, hierarchy, cv.RETR_TREE, cv.CHAIN_APPROX_SIMPLE);
                
                const targetRowRects = [];
                for (let i = 0; i < contours.size(); ++i) {
                    let cnt = contours.get(i);
                    let rect = cv.boundingRect(cnt);
                    if (rect.y > rowY - yTolerance && rect.y < rowY + rowHeight && rect.width > 10 && rect.height > 10) {
                         targetRowRects.push(rect);
                    }
                    cnt.delete();
                }

                if (targetRowRects.length === 0) {
                    throw new Error('Gagal menemukan kontur sel di dalam baris yang diidentifikasi.');
                }
                logToUI(`  > Ditemukan ${targetRowRects.length} sel presisi di dalam baris target.`, 'success');

                logToUI('Langkah 5: Memotong Gambar Asli', 'step');
                const padding = 5;
                const minX = Math.min(...targetRowRects.map(r => r.x)) - padding;
                const minY = Math.min(...targetRowRects.map(r => r.y)) - padding;
                const maxX = Math.max(...targetRowRects.map(r => r.x + r.width)) + padding;
                const maxY = Math.max(...targetRowRects.map(r => r.y + r.height)) + padding;
                
                const finalRect = new cv.Rect(
                    Math.max(0, minX),
                    Math.max(0, minY),
                    Math.min(src.cols - Math.max(0, minX), maxX - minX),
                    Math.min(src.rows - Math.max(0, minY), maxY - minY)
                );
                finalCrop = src.roi(finalRect);
                logToUI('  > Gambar asli berhasil dipotong.', 'info');

                const resultCanvas = document.createElement('canvas');
                cv.imshow(resultCanvas, finalCrop);
                
                resultContainer.innerHTML = '<h2>Hasil Potongan Final:</h2>';
                const resultImage = new Image();
                resultImage.src = resultCanvas.toDataURL('image/png');
                resultContainer.appendChild(resultImage);

                logToUI('PROSES SELESAI!', 'success');

            } catch (error) {
                console.error("Terjadi kesalahan:", error);
                logToUI(`Error: ${error.message}`, 'error');
            } finally {
                if (src) src.delete();
                if (gray) gray.delete();
                if (binary) binary.delete();
                if (invertedBinary) invertedBinary.delete();
                if (contours) contours.delete();
                if (hierarchy) hierarchy.delete();
                if (finalCrop) finalCrop.delete();
                
                processButton.disabled = false;
                processButton.textContent = 'Mulai Proses Cepat';
            }
        }
    </script>

</body>
</html>
